<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>rollupTree • rollupTree</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="rollupTree">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rollupTree</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/rollupTree.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jsjuni/rollupTree/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>rollupTree</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jsjuni/rollupTree/blob/main/vignettes/rollupTree.Rmd" class="external-link"><code>vignettes/rollupTree.Rmd</code></a></small>
      <div class="d-none name"><code>rollupTree.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jsjuni.github.io/rollupTree/">rollupTree</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p><code>rollupTree</code> implements a general function for
computations in which some property of a parent element is a combination
of corresponding properties of its child elements. The mass of an
assembly, for example, is the sum of the masses of its subassemblies,
and the mass of each subassembly is the sum of masses of its parts,
etc.</p>
<p><code>rollupTree</code> can perform computations specified by
arbitrarily-shaped (but well-formed) trees, arbitrarily-defined
properties and property-combining operations. Defaults are provided to
simplify common cases (atomic numerical properties combined by summing),
but functional programming techniques allow the caller to pass arbitrary
<em>update</em> methods as required.</p>
<p>Despite its name, rollupTree can operate on directed acyclic graphs
that are not trees if instructed to apply less stringent validation
rules to its input. See <code><a href="../reference/default_validate_dag.html">default_validate_dag()</a></code> and
<code><a href="../reference/rollup.html">rollup()</a></code>.</p>
</div>
<div class="section level2">
<h2 id="example-with-a-data-frame">Example With A Data Frame<a class="anchor" aria-label="anchor" href="#example-with-a-data-frame"></a>
</h2>
<p>Consider this example Work Breakdown Structure from <a href="https://www.workbreakdownstructure.com" class="external-link">WorkBreakdownStructure.com</a>:</p>
<p><a href="https://www.workbreakdownstructure.com" class="external-link"><img src="wbs.jpg" alt="Example Work Breakdown Structure. Source: www.workbreakdownstructure.com"></a></p>
<p>The computations in the example are worked out already; we show here
how to reproduce them.</p>
<p>A Work Breakdown Structure is a tree, that is, a graph that is
connected and acyclic. It is, in addition, directed, that is, the edges
have direction. We arbitrarily chose the edge direction to go from child
to parent. Finally, it is single-rooted: every vertex but one has a
single parent vertex; the root vertex has no parent.</p>
<p>The leaf elements (vertices) of the tree require asserted values for
the properties (work, budget) of interest. Property values for non-leaf
elements are computed by <code><a href="../reference/rollup.html">rollup()</a></code>.</p>
<p>We begin by capturing the structure of the tree and asserted values
in a data frame we call <code>wbs_table</code>. Values to be computed
are initially unknown. Each element is uniquely identified by an
<code>id</code> column<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;&lt;code&gt;id&lt;/code&gt; is the default but any valid column name
can be used. Values should be character data.&lt;/p&gt;"><sup>1</sup></a>. We also indicate parent id in the
<code>pid</code> column but this information is not used directly by
<code><a href="../reference/rollup.html">rollup()</a></code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jsjuni.github.io/rollupTree/">rollupTree</a></span><span class="op">)</span></span>
<span><span class="va">wbs_table</span></span>
<span><span class="co">#&gt;     id  pid                    name work budget</span></span>
<span><span class="co">#&gt; 1  top &lt;NA&gt; Construction of a House   NA     NA</span></span>
<span><span class="co">#&gt; 2    1  top                Internal   NA     NA</span></span>
<span><span class="co">#&gt; 3    2  top              Foundation   NA     NA</span></span>
<span><span class="co">#&gt; 4    3  top                External   NA     NA</span></span>
<span><span class="co">#&gt; 5  1.1    1              Electrical 11.8  25000</span></span>
<span><span class="co">#&gt; 6  1.2    1                Plumbing 33.8  61000</span></span>
<span><span class="co">#&gt; 7  2.1    2                Excavate 18.2  37000</span></span>
<span><span class="co">#&gt; 8  2.2    2          Steel Erection  5.8   9000</span></span>
<span><span class="co">#&gt; 9  3.1    3            Masonry Work 16.2  62000</span></span>
<span><span class="co">#&gt; 10 3.2    3       Building Finishes 14.2  21500</span></span></code></pre></div>
<p>A key feature of recursively-defined problems like this is that the
computations must be ordered in such a way that the computations for a
given element must occur after properties for it children are known
(either asserted or computed). Traversing a tree in this manner can be
achieved by using a well-known algorithm in graph theory known as
<em>topological sort</em>. For that reason, we construct an
<code>igraph</code> <span class="citation">(Csárdi et al. 2025)</span>
graph object in R, from which we can conveniently (1) check that the
graph is in fact a well-formed tree, and (2) efficiently execute a
topological sort to order the computations. (Note that, although the
problems solved by rollup are <em>defined</em> recursively, the
implementation in software is not recursive.)</p>
<p>It is a simple matter to construct a graph from the information in
our data frame:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jsjuni.github.io/rollupTree/">rollupTree</a></span><span class="op">)</span></span>
<span><span class="va">wbs_tree</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_rollup_tree.html">create_rollup_tree</a></span><span class="op">(</span></span>
<span>  get_keys <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="va">wbs_table</span><span class="op">$</span><span class="va">id</span>,</span>
<span>  get_parent_key_by_child_key <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">key</span><span class="op">)</span> <span class="va">wbs_table</span><span class="op">[</span><span class="va">wbs_table</span><span class="op">$</span><span class="va">id</span> <span class="op">==</span> <span class="va">key</span>, <span class="st">"pid"</span><span class="op">]</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="wbs-tree">
<img src="wbs_tree.png" alt="WBS Tree"><a class="anchor" aria-label="anchor" href="#wbs-tree"></a>
</h3>
<p>A directed acyclic graph may have more than one topological sort; any
is suitable for our purpose. Here is what <code><a href="../reference/rollup.html">rollup()</a></code> uses
internally:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">igraph</span><span class="fu">::</span><span class="fu"><a href="https://r.igraph.org/reference/topo_sort.html" class="external-link">topo_sort</a></span><span class="op">(</span><span class="va">wbs_tree</span><span class="op">)</span></span>
<span><span class="co">#&gt; + 10/10 vertices, named, from d73ade8:</span></span>
<span><span class="co">#&gt;  [1] 1.1 1.2 2.1 2.2 3.1 3.2 1   2   3   top</span></span></code></pre></div>
<!--# plot created by coords <- layout_(wbs_tree, as_tree(mode="in")) plot(wbs_tree, layout=coords, vertex.size = 30) -->
</div>
<div class="section level3">
<h3 id="summing-a-single-numeric-property">Summing a Single Numeric Property<a class="anchor" aria-label="anchor" href="#summing-a-single-numeric-property"></a>
</h3>
<p>Although our data in this first example is a data frame,
<code><a href="../reference/rollup.html">rollup()</a></code> can operate on an arbitrary R object if provided
with <em>update</em> and <em>validate</em> methods for that object. For
the common case in which the parameter of interest is a numeric column
in a data frame, the combine operation is addition, and the key column
is named <code>id</code>, the package provides
<code><a href="../reference/update_df_prop_by_id.html">update_df_prop_by_id()</a></code> and <code><a href="../reference/validate_df_by_id.html">validate_df_by_id()</a></code>
functions that can be invoked as boilerplate. To roll up the
<code>work</code> property, for example, we simply invoke:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rollup.html">rollup</a></span><span class="op">(</span></span>
<span>  tree<span class="op">=</span><span class="va">wbs_tree</span>,</span>
<span>  ds<span class="op">=</span><span class="va">wbs_table</span>,</span>
<span>  update<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">d</span>, <span class="va">t</span>, <span class="va">s</span><span class="op">)</span> <span class="fu"><a href="../reference/update_df_prop_by_id.html">update_df_prop_by_id</a></span><span class="op">(</span>df<span class="op">=</span><span class="va">d</span>, target<span class="op">=</span><span class="va">t</span>, sources<span class="op">=</span><span class="va">s</span>, prop<span class="op">=</span><span class="st">"work"</span><span class="op">)</span>,</span>
<span>  validate_ds<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">t</span>, <span class="va">d</span><span class="op">)</span> <span class="fu"><a href="../reference/validate_df_by_id.html">validate_df_by_id</a></span><span class="op">(</span>tree<span class="op">=</span><span class="va">t</span>, df<span class="op">=</span><span class="va">d</span>, prop<span class="op">=</span><span class="st">"work"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;     id  pid                    name  work budget</span></span>
<span><span class="co">#&gt; 1  top &lt;NA&gt; Construction of a House 100.0     NA</span></span>
<span><span class="co">#&gt; 2    1  top                Internal  45.6     NA</span></span>
<span><span class="co">#&gt; 3    2  top              Foundation  24.0     NA</span></span>
<span><span class="co">#&gt; 4    3  top                External  30.4     NA</span></span>
<span><span class="co">#&gt; 5  1.1    1              Electrical  11.8  25000</span></span>
<span><span class="co">#&gt; 6  1.2    1                Plumbing  33.8  61000</span></span>
<span><span class="co">#&gt; 7  2.1    2                Excavate  18.2  37000</span></span>
<span><span class="co">#&gt; 8  2.2    2          Steel Erection   5.8   9000</span></span>
<span><span class="co">#&gt; 9  3.1    3            Masonry Work  16.2  62000</span></span>
<span><span class="co">#&gt; 10 3.2    3       Building Finishes  14.2  21500</span></span></code></pre></div>
<p><code><a href="../reference/update_df_prop_by_id.html">update_df_prop_by_id()</a></code> (like every well-behaved
<em>update</em> method) modifies only the specified column and leaves
the rest of the data frame unchanged. If we want to roll up the
<code>budget</code> column as well, we can simply chain two
<code><a href="../reference/rollup.html">rollup()</a></code>s together. In this example we use R’s pipe
operator:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rollup.html">rollup</a></span><span class="op">(</span></span>
<span>  tree<span class="op">=</span><span class="va">wbs_tree</span>,</span>
<span>  ds<span class="op">=</span><span class="va">wbs_table</span>,</span>
<span>  update<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">d</span>, <span class="va">t</span>, <span class="va">s</span><span class="op">)</span> <span class="fu"><a href="../reference/update_df_prop_by_id.html">update_df_prop_by_id</a></span><span class="op">(</span>df<span class="op">=</span><span class="va">d</span>, target<span class="op">=</span><span class="va">t</span>, sources<span class="op">=</span><span class="va">s</span>, prop<span class="op">=</span><span class="st">"work"</span><span class="op">)</span>,</span>
<span>  validate_ds<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">t</span>, <span class="va">d</span><span class="op">)</span> <span class="fu"><a href="../reference/validate_df_by_id.html">validate_df_by_id</a></span><span class="op">(</span>tree<span class="op">=</span><span class="va">t</span>, df<span class="op">=</span><span class="va">d</span>, prop<span class="op">=</span><span class="st">"work"</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/rollup.html">rollup</a></span><span class="op">(</span></span>
<span>  tree<span class="op">=</span><span class="va">wbs_tree</span>,</span>
<span>  ds<span class="op">=</span><span class="va">_</span>,</span>
<span>  update<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">d</span>, <span class="va">t</span>, <span class="va">s</span><span class="op">)</span> <span class="fu"><a href="../reference/update_df_prop_by_id.html">update_df_prop_by_id</a></span><span class="op">(</span>df<span class="op">=</span><span class="va">d</span>, target<span class="op">=</span><span class="va">t</span>, sources<span class="op">=</span><span class="va">s</span>, prop<span class="op">=</span><span class="st">"budget"</span><span class="op">)</span>,</span>
<span>  validate_ds<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">t</span>, <span class="va">d</span><span class="op">)</span> <span class="fu"><a href="../reference/validate_df_by_id.html">validate_df_by_id</a></span><span class="op">(</span>tree<span class="op">=</span><span class="va">t</span>, df<span class="op">=</span><span class="va">d</span>, prop<span class="op">=</span><span class="st">"budget"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;     id  pid                    name  work budget</span></span>
<span><span class="co">#&gt; 1  top &lt;NA&gt; Construction of a House 100.0 215500</span></span>
<span><span class="co">#&gt; 2    1  top                Internal  45.6  86000</span></span>
<span><span class="co">#&gt; 3    2  top              Foundation  24.0  46000</span></span>
<span><span class="co">#&gt; 4    3  top                External  30.4  83500</span></span>
<span><span class="co">#&gt; 5  1.1    1              Electrical  11.8  25000</span></span>
<span><span class="co">#&gt; 6  1.2    1                Plumbing  33.8  61000</span></span>
<span><span class="co">#&gt; 7  2.1    2                Excavate  18.2  37000</span></span>
<span><span class="co">#&gt; 8  2.2    2          Steel Erection   5.8   9000</span></span>
<span><span class="co">#&gt; 9  3.1    3            Masonry Work  16.2  62000</span></span>
<span><span class="co">#&gt; 10 3.2    3       Building Finishes  14.2  21500</span></span></code></pre></div>
<p>In most cases, this approach suffices. The code is simple and clear,
and performance is not typically an issue. (In other testing
<code><a href="../reference/rollup.html">rollup()</a></code> performs tens of thousands of non-trivial property
updates per second.) We show here some alternate approaches, mainly to
illustrate architectural features of the approach that may be useful for
more esoteric applications.</p>
</div>
<div class="section level3">
<h3 id="chaining-update-methods">Chaining Update Methods<a class="anchor" aria-label="anchor" href="#chaining-update-methods"></a>
</h3>
<p>A valid <em>update</em> method returns the updated data set, so we
can chain two updates within a single <code><a href="../reference/rollup.html">rollup()</a></code> instead of
chaining two <code><a href="../reference/rollup.html">rollup()</a></code>s. Similarly, a data set validator
returns a logical value, so we can make the conjunction of two
validators:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rollup.html">rollup</a></span><span class="op">(</span></span>
<span>  tree <span class="op">=</span> <span class="va">wbs_tree</span>,</span>
<span>  ds <span class="op">=</span> <span class="va">wbs_table</span>,</span>
<span>  update <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">d</span>, <span class="va">t</span>, <span class="va">s</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/update_df_prop_by_id.html">update_df_prop_by_id</a></span><span class="op">(</span></span>
<span>      df <span class="op">=</span> <span class="va">d</span>,</span>
<span>      target <span class="op">=</span> <span class="va">t</span>,</span>
<span>      sources <span class="op">=</span> <span class="va">s</span>,</span>
<span>      prop <span class="op">=</span> <span class="st">"work"</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="../reference/update_df_prop_by_id.html">update_df_prop_by_id</a></span><span class="op">(</span>target <span class="op">=</span> <span class="va">t</span>,</span>
<span>                           sources <span class="op">=</span> <span class="va">s</span>,</span>
<span>                           prop <span class="op">=</span> <span class="st">"budget"</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  validate_ds <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span>, <span class="va">d</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/validate_df_by_id.html">validate_df_by_id</a></span><span class="op">(</span>tree <span class="op">=</span> <span class="va">t</span>, df <span class="op">=</span> <span class="va">d</span>, prop <span class="op">=</span> <span class="st">"work"</span><span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span>      <span class="fu"><a href="../reference/validate_df_by_id.html">validate_df_by_id</a></span><span class="op">(</span>tree <span class="op">=</span> <span class="va">t</span>, df <span class="op">=</span> <span class="va">d</span>, prop <span class="op">=</span> <span class="st">"budget"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;     id  pid                    name  work budget</span></span>
<span><span class="co">#&gt; 1  top &lt;NA&gt; Construction of a House 100.0 215500</span></span>
<span><span class="co">#&gt; 2    1  top                Internal  45.6  86000</span></span>
<span><span class="co">#&gt; 3    2  top              Foundation  24.0  46000</span></span>
<span><span class="co">#&gt; 4    3  top                External  30.4  83500</span></span>
<span><span class="co">#&gt; 5  1.1    1              Electrical  11.8  25000</span></span>
<span><span class="co">#&gt; 6  1.2    1                Plumbing  33.8  61000</span></span>
<span><span class="co">#&gt; 7  2.1    2                Excavate  18.2  37000</span></span>
<span><span class="co">#&gt; 8  2.2    2          Steel Erection   5.8   9000</span></span>
<span><span class="co">#&gt; 9  3.1    3            Masonry Work  16.2  62000</span></span>
<span><span class="co">#&gt; 10 3.2    3       Building Finishes  14.2  21500</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="custom-get-set-and-update-methods">Custom <em>get</em>, <em>set</em>, and <em>update</em> Methods<a class="anchor" aria-label="anchor" href="#custom-get-set-and-update-methods"></a>
</h3>
<p>In this example we create a custom <em>get</em> method that builds a
named vector from the specified properties (using lower-level function
<code><a href="../reference/df_get_by_id.html">df_get_by_id()</a></code>) and a corresponding <em>set</em> method
(using <code><a href="../reference/df_set_by_id.html">df_set_by_id()</a></code>). We then create a custom
<em>update</em> method using these methods. (The default
<em>combine</em> method still works because R knows how to add vectors.)
Finally, we create a custom data set validator and invoke
<code><a href="../reference/rollup.html">rollup()</a></code> with our custom methods.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_get</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">d</span>, <span class="va">i</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  w<span class="op">=</span><span class="fu"><a href="../reference/df_get_by_id.html">df_get_by_id</a></span><span class="op">(</span>df<span class="op">=</span><span class="va">d</span>, id<span class="op">=</span><span class="va">i</span>, prop<span class="op">=</span><span class="st">"work"</span><span class="op">)</span>,</span>
<span>  b<span class="op">=</span><span class="fu"><a href="../reference/df_get_by_id.html">df_get_by_id</a></span><span class="op">(</span>df<span class="op">=</span><span class="va">d</span>, id<span class="op">=</span><span class="va">i</span>, prop<span class="op">=</span><span class="st">"budget"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">my_set</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">d</span>, <span class="va">i</span>, <span class="va">v</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/df_set_by_id.html">df_set_by_id</a></span><span class="op">(</span>df<span class="op">=</span><span class="va">d</span>, id<span class="op">=</span><span class="va">i</span>, prop<span class="op">=</span><span class="st">"work"</span>, val<span class="op">=</span><span class="va">v</span><span class="op">[</span><span class="st">"w"</span><span class="op">]</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/df_set_by_id.html">df_set_by_id</a></span><span class="op">(</span>id<span class="op">=</span><span class="va">i</span>, prop<span class="op">=</span><span class="st">"budget"</span>, val<span class="op">=</span><span class="va">v</span><span class="op">[</span><span class="st">"b"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">my_update</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">d</span>, <span class="va">t</span>, <span class="va">s</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/update_prop.html">update_prop</a></span><span class="op">(</span>ds<span class="op">=</span><span class="va">d</span>, target<span class="op">=</span><span class="va">t</span>, sources<span class="op">=</span><span class="va">s</span>, set<span class="op">=</span><span class="va">my_set</span>, get<span class="op">=</span><span class="va">my_get</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">my_validate</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span>, <span class="va">d</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/validate_ds.html">validate_ds</a></span><span class="op">(</span>tree<span class="op">=</span><span class="va">t</span>, ds<span class="op">=</span><span class="va">d</span>,</span>
<span>               get_keys<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="fu"><a href="../reference/df_get_ids.html">df_get_ids</a></span><span class="op">(</span>df<span class="op">=</span><span class="va">d</span><span class="op">)</span>,</span>
<span>               get_prop<span class="op">=</span><span class="va">my_get</span>,</span>
<span>               op<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="fu">my_check</span><span class="op">(</span><span class="va">v</span><span class="op">[</span><span class="st">"w"</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu">my_check</span><span class="op">(</span><span class="va">v</span><span class="op">[</span><span class="st">"b"</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">my_check</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">v</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">(</span><span class="va">v</span> <span class="op">&gt;</span> <span class="fl">0.0</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/rollup.html">rollup</a></span><span class="op">(</span></span>
<span>  tree <span class="op">=</span> <span class="va">wbs_tree</span>,</span>
<span>  ds <span class="op">=</span> <span class="va">wbs_table</span>,</span>
<span>  update <span class="op">=</span> <span class="va">my_update</span>,</span>
<span>  validate_ds <span class="op">=</span> <span class="va">my_validate</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;     id  pid                    name  work budget</span></span>
<span><span class="co">#&gt; 1  top &lt;NA&gt; Construction of a House 100.0 215500</span></span>
<span><span class="co">#&gt; 2    1  top                Internal  45.6  86000</span></span>
<span><span class="co">#&gt; 3    2  top              Foundation  24.0  46000</span></span>
<span><span class="co">#&gt; 4    3  top                External  30.4  83500</span></span>
<span><span class="co">#&gt; 5  1.1    1              Electrical  11.8  25000</span></span>
<span><span class="co">#&gt; 6  1.2    1                Plumbing  33.8  61000</span></span>
<span><span class="co">#&gt; 7  2.1    2                Excavate  18.2  37000</span></span>
<span><span class="co">#&gt; 8  2.2    2          Steel Erection   5.8   9000</span></span>
<span><span class="co">#&gt; 9  3.1    3            Masonry Work  16.2  62000</span></span>
<span><span class="co">#&gt; 10 3.2    3       Building Finishes  14.2  21500</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="custom-combine-method">Custom <em>combine</em> Method<a class="anchor" aria-label="anchor" href="#custom-combine-method"></a>
</h3>
<p>Finally, we illustrate the use of a custom combiner. Suppose we have
5% uncertainty in our leaf cost numbers. Add those uncertainty numbers
to our data frame:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_wbs_table</span> <span class="op">&lt;-</span> <span class="va">wbs_table</span></span>
<span><span class="va">new_wbs_table</span><span class="op">$</span><span class="va">work</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="va">new_wbs_table</span><span class="op">$</span><span class="va">budget_unc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">wbs_table</span><span class="op">$</span><span class="va">budget</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="va">wbs_table</span><span class="op">$</span><span class="va">budget</span> <span class="op">*</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="va">new_wbs_table</span></span>
<span><span class="co">#&gt;     id  pid                    name budget budget_unc</span></span>
<span><span class="co">#&gt; 1  top &lt;NA&gt; Construction of a House     NA         NA</span></span>
<span><span class="co">#&gt; 2    1  top                Internal     NA         NA</span></span>
<span><span class="co">#&gt; 3    2  top              Foundation     NA         NA</span></span>
<span><span class="co">#&gt; 4    3  top                External     NA         NA</span></span>
<span><span class="co">#&gt; 5  1.1    1              Electrical  25000       1250</span></span>
<span><span class="co">#&gt; 6  1.2    1                Plumbing  61000       3050</span></span>
<span><span class="co">#&gt; 7  2.1    2                Excavate  37000       1850</span></span>
<span><span class="co">#&gt; 8  2.2    2          Steel Erection   9000        450</span></span>
<span><span class="co">#&gt; 9  3.1    3            Masonry Work  62000       3100</span></span>
<span><span class="co">#&gt; 10 3.2    3       Building Finishes  21500       1075</span></span></code></pre></div>
<p>The standard technique for accumulating uncertainties is to combine
using root-sum-square (RSS).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combine_rss</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">vl</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span>f <span class="op">=</span> <span class="va">`+`</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Map</a></span><span class="op">(</span></span>
<span>    f <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">v</span><span class="op">)</span></span>
<span>      <span class="va">v</span> <span class="op">*</span> <span class="va">v</span>,</span>
<span>    <span class="va">vl</span></span>
<span>  <span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rollup.html">rollup</a></span><span class="op">(</span></span>
<span>  tree <span class="op">=</span> <span class="va">wbs_tree</span>,</span>
<span>  ds <span class="op">=</span> <span class="va">new_wbs_table</span>,</span>
<span>  update <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">d</span>, <span class="va">t</span>, <span class="va">s</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="../reference/update_df_prop_by_id.html">update_df_prop_by_id</a></span><span class="op">(</span></span>
<span>      df <span class="op">=</span> <span class="va">d</span>,</span>
<span>      target <span class="op">=</span> <span class="va">t</span>,</span>
<span>      sources <span class="op">=</span> <span class="va">s</span>,</span>
<span>      prop <span class="op">=</span> <span class="st">"budget"</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/update_df_prop_by_id.html">update_df_prop_by_id</a></span><span class="op">(</span></span>
<span>      target <span class="op">=</span> <span class="va">t</span>,</span>
<span>      sources <span class="op">=</span> <span class="va">s</span>,</span>
<span>      prop <span class="op">=</span> <span class="st">"budget_unc"</span>,</span>
<span>      combine <span class="op">=</span> <span class="va">combine_rss</span></span>
<span>    <span class="op">)</span>,</span>
<span>  validate_ds <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span>, <span class="va">d</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="../reference/validate_df_by_id.html">validate_df_by_id</a></span><span class="op">(</span>tree <span class="op">=</span> <span class="va">t</span>, df <span class="op">=</span> <span class="va">d</span>, prop <span class="op">=</span> <span class="st">"budget_unc"</span><span class="op">)</span>,</span>
<span><span class="op">)</span></span>
<span><span class="va">result</span><span class="op">$</span><span class="va">budget_unc_pct</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="va">budget_unc</span> <span class="op">/</span> <span class="va">result</span><span class="op">$</span><span class="va">budget</span> <span class="op">*</span> <span class="fl">100.</span></span>
<span><span class="va">result</span></span>
<span><span class="co">#&gt;     id  pid                    name budget budget_unc budget_unc_pct</span></span>
<span><span class="co">#&gt; 1  top &lt;NA&gt; Construction of a House 215500   5025.497       2.332017</span></span>
<span><span class="co">#&gt; 2    1  top                Internal  86000   3296.210       3.832802</span></span>
<span><span class="co">#&gt; 3    2  top              Foundation  46000   1903.943       4.139007</span></span>
<span><span class="co">#&gt; 4    3  top                External  83500   3281.101       3.929462</span></span>
<span><span class="co">#&gt; 5  1.1    1              Electrical  25000   1250.000       5.000000</span></span>
<span><span class="co">#&gt; 6  1.2    1                Plumbing  61000   3050.000       5.000000</span></span>
<span><span class="co">#&gt; 7  2.1    2                Excavate  37000   1850.000       5.000000</span></span>
<span><span class="co">#&gt; 8  2.2    2          Steel Erection   9000    450.000       5.000000</span></span>
<span><span class="co">#&gt; 9  3.1    3            Masonry Work  62000   3100.000       5.000000</span></span>
<span><span class="co">#&gt; 10 3.2    3       Building Finishes  21500   1075.000       5.000000</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="example-with-a-list">Example With A List<a class="anchor" aria-label="anchor" href="#example-with-a-list"></a>
</h2>
<p>Suppose instead of a data frame we have a list of lists:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wbs_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">wbs_table</span>, <span class="va">wbs_table</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>,</span>
<span>                   <span class="kw">function</span><span class="op">(</span><span class="va">r</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">r</span><span class="op">$</span><span class="va">name</span>, budget <span class="op">=</span> <span class="va">r</span><span class="op">$</span><span class="va">budget</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">wbs_list</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 10</span></span>
<span><span class="co">#&gt;  $ 1  :List of 2</span></span>
<span><span class="co">#&gt;   ..$ name  : chr "Internal"</span></span>
<span><span class="co">#&gt;   ..$ budget: num NA</span></span>
<span><span class="co">#&gt;  $ 1.1:List of 2</span></span>
<span><span class="co">#&gt;   ..$ name  : chr "Electrical"</span></span>
<span><span class="co">#&gt;   ..$ budget: num 25000</span></span>
<span><span class="co">#&gt;  $ 1.2:List of 2</span></span>
<span><span class="co">#&gt;   ..$ name  : chr "Plumbing"</span></span>
<span><span class="co">#&gt;   ..$ budget: num 61000</span></span>
<span><span class="co">#&gt;  $ 2  :List of 2</span></span>
<span><span class="co">#&gt;   ..$ name  : chr "Foundation"</span></span>
<span><span class="co">#&gt;   ..$ budget: num NA</span></span>
<span><span class="co">#&gt;  $ 2.1:List of 2</span></span>
<span><span class="co">#&gt;   ..$ name  : chr "Excavate"</span></span>
<span><span class="co">#&gt;   ..$ budget: num 37000</span></span>
<span><span class="co">#&gt;  $ 2.2:List of 2</span></span>
<span><span class="co">#&gt;   ..$ name  : chr "Steel Erection"</span></span>
<span><span class="co">#&gt;   ..$ budget: num 9000</span></span>
<span><span class="co">#&gt;  $ 3  :List of 2</span></span>
<span><span class="co">#&gt;   ..$ name  : chr "External"</span></span>
<span><span class="co">#&gt;   ..$ budget: num NA</span></span>
<span><span class="co">#&gt;  $ 3.1:List of 2</span></span>
<span><span class="co">#&gt;   ..$ name  : chr "Masonry Work"</span></span>
<span><span class="co">#&gt;   ..$ budget: num 62000</span></span>
<span><span class="co">#&gt;  $ 3.2:List of 2</span></span>
<span><span class="co">#&gt;   ..$ name  : chr "Building Finishes"</span></span>
<span><span class="co">#&gt;   ..$ budget: num 21500</span></span>
<span><span class="co">#&gt;  $ top:List of 2</span></span>
<span><span class="co">#&gt;   ..$ name  : chr "Construction of a House"</span></span>
<span><span class="co">#&gt;   ..$ budget: num NA</span></span></code></pre></div>
<p>We construct <em>update</em> and <em>validate</em> functions as
follows:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">list_get</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">d</span>, <span class="va">i</span><span class="op">)</span> <span class="va">d</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">budget</span></span>
<span><span class="va">list_set</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">d</span>, <span class="va">i</span>, <span class="va">v</span><span class="op">)</span> <span class="op">{</span> <span class="va">d</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">budget</span> <span class="op">=</span> <span class="va">v</span>; <span class="va">d</span> <span class="op">}</span></span>
<span><span class="va">list_update</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">d</span>, <span class="va">t</span>, <span class="va">s</span><span class="op">)</span> <span class="op">{</span> <span class="fu"><a href="../reference/update_prop.html">update_prop</a></span><span class="op">(</span><span class="va">d</span>, <span class="va">t</span>, <span class="va">s</span>, <span class="va">list_set</span>, <span class="va">list_get</span><span class="op">)</span> <span class="op">}</span></span>
<span><span class="va">list_validate</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span>, <span class="va">d</span><span class="op">)</span> <span class="fu"><a href="../reference/validate_ds.html">validate_ds</a></span><span class="op">(</span><span class="va">t</span>, <span class="va">d</span>, get_keys <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">l</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span>, get <span class="op">=</span> <span class="va">list_get</span><span class="op">)</span></span></code></pre></div>
<p>The output of <code><a href="../reference/rollup.html">rollup()</a></code> is as expected:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">list_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rollup.html">rollup</a></span><span class="op">(</span><span class="va">wbs_tree</span>, <span class="va">wbs_list</span>, <span class="va">list_update</span>, <span class="va">list_validate</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">list_result</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 10</span></span>
<span><span class="co">#&gt;  $ 1  :List of 2</span></span>
<span><span class="co">#&gt;   ..$ name  : chr "Internal"</span></span>
<span><span class="co">#&gt;   ..$ budget: num 86000</span></span>
<span><span class="co">#&gt;  $ 1.1:List of 2</span></span>
<span><span class="co">#&gt;   ..$ name  : chr "Electrical"</span></span>
<span><span class="co">#&gt;   ..$ budget: num 25000</span></span>
<span><span class="co">#&gt;  $ 1.2:List of 2</span></span>
<span><span class="co">#&gt;   ..$ name  : chr "Plumbing"</span></span>
<span><span class="co">#&gt;   ..$ budget: num 61000</span></span>
<span><span class="co">#&gt;  $ 2  :List of 2</span></span>
<span><span class="co">#&gt;   ..$ name  : chr "Foundation"</span></span>
<span><span class="co">#&gt;   ..$ budget: num 46000</span></span>
<span><span class="co">#&gt;  $ 2.1:List of 2</span></span>
<span><span class="co">#&gt;   ..$ name  : chr "Excavate"</span></span>
<span><span class="co">#&gt;   ..$ budget: num 37000</span></span>
<span><span class="co">#&gt;  $ 2.2:List of 2</span></span>
<span><span class="co">#&gt;   ..$ name  : chr "Steel Erection"</span></span>
<span><span class="co">#&gt;   ..$ budget: num 9000</span></span>
<span><span class="co">#&gt;  $ 3  :List of 2</span></span>
<span><span class="co">#&gt;   ..$ name  : chr "External"</span></span>
<span><span class="co">#&gt;   ..$ budget: num 83500</span></span>
<span><span class="co">#&gt;  $ 3.1:List of 2</span></span>
<span><span class="co">#&gt;   ..$ name  : chr "Masonry Work"</span></span>
<span><span class="co">#&gt;   ..$ budget: num 62000</span></span>
<span><span class="co">#&gt;  $ 3.2:List of 2</span></span>
<span><span class="co">#&gt;   ..$ name  : chr "Building Finishes"</span></span>
<span><span class="co">#&gt;   ..$ budget: num 21500</span></span>
<span><span class="co">#&gt;  $ top:List of 2</span></span>
<span><span class="co">#&gt;   ..$ name  : chr "Construction of a House"</span></span>
<span><span class="co">#&gt;   ..$ budget: num 215500</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="example-with-a-tree">Example With A Tree<a class="anchor" aria-label="anchor" href="#example-with-a-tree"></a>
</h2>
<p>The tree can serve as the dataset with proper attributes and methods.
To illustrate, we add the budget figures from our data frame as vertex
attributes to the tree:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r.igraph.org/" class="external-link">igraph</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'igraph'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     decompose, spectrum</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     union</span></span>
<span><span class="va">new_wbs_tree</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span></span>
<span>  f <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">g</span>, <span class="va">k</span><span class="op">)</span> <span class="fu"><a href="https://r.igraph.org/reference/set_vertex_attr.html" class="external-link">set_vertex_attr</a></span><span class="op">(</span><span class="va">g</span>, <span class="st">'budget'</span>, <span class="va">k</span>, <span class="fu"><a href="../reference/df_get_by_id.html">df_get_by_id</a></span><span class="op">(</span><span class="va">wbs_table</span>, <span class="va">k</span>, <span class="st">'budget'</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://r.igraph.org/reference/V.html" class="external-link">V</a></span><span class="op">(</span><span class="va">wbs_tree</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  init <span class="op">=</span> <span class="va">wbs_tree</span></span>
<span><span class="op">)</span></span>
<span><span class="va">ib</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r.igraph.org/reference/vertex_attr.html" class="external-link">vertex_attr</a></span><span class="op">(</span><span class="va">new_wbs_tree</span>, <span class="st">"budget"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ib</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://r.igraph.org/reference/V.html" class="external-link">V</a></span><span class="op">(</span><span class="va">new_wbs_tree</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ib</span></span>
<span><span class="co">#&gt;   top     1     2     3   1.1   1.2   2.1   2.2   3.1   3.2 </span></span>
<span><span class="co">#&gt;    NA    NA    NA    NA 25000 61000 37000  9000 62000 21500</span></span></code></pre></div>
<p>We construct <em>update</em> and <em>validate</em> functions as
follows:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tree_get</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">d</span>, <span class="va">k</span><span class="op">)</span> <span class="fu"><a href="https://r.igraph.org/reference/vertex_attr.html" class="external-link">vertex_attr</a></span><span class="op">(</span><span class="va">d</span>, <span class="st">"budget"</span>, <span class="va">k</span><span class="op">)</span></span>
<span><span class="va">tree_set</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">d</span>, <span class="va">k</span>, <span class="va">v</span><span class="op">)</span> <span class="fu"><a href="https://r.igraph.org/reference/set_vertex_attr.html" class="external-link">set_vertex_attr</a></span><span class="op">(</span><span class="va">d</span>, <span class="st">"budget"</span>, <span class="va">k</span>, <span class="va">v</span><span class="op">)</span></span>
<span><span class="va">tree_update</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">d</span>, <span class="va">t</span>, <span class="va">s</span><span class="op">)</span> <span class="fu"><a href="../reference/update_prop.html">update_prop</a></span><span class="op">(</span><span class="va">d</span>, <span class="va">t</span>, <span class="va">s</span>, set <span class="op">=</span> <span class="va">tree_set</span>, get <span class="op">=</span> <span class="va">tree_get</span><span class="op">)</span></span>
<span><span class="va">tree_validate</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span>, <span class="va">d</span><span class="op">)</span> <span class="fu"><a href="../reference/validate_ds.html">validate_ds</a></span><span class="op">(</span><span class="va">t</span>, <span class="va">d</span>, get_keys <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://r.igraph.org/reference/V.html" class="external-link">V</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">)</span>, get <span class="op">=</span> <span class="va">tree_get</span><span class="op">)</span></span></code></pre></div>
<p>The output of <code><a href="../reference/rollup.html">rollup()</a></code> is as expected:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tree_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rollup.html">rollup</a></span><span class="op">(</span><span class="va">new_wbs_tree</span>, <span class="va">new_wbs_tree</span>, update <span class="op">=</span> <span class="va">tree_update</span>, validate_ds <span class="op">=</span> <span class="va">tree_validate</span><span class="op">)</span></span>
<span><span class="va">ob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r.igraph.org/reference/vertex_attr.html" class="external-link">vertex_attr</a></span><span class="op">(</span><span class="va">tree_result</span>, <span class="st">"budget"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">ob</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://r.igraph.org/reference/V.html" class="external-link">V</a></span><span class="op">(</span><span class="va">tree_result</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ob</span></span>
<span><span class="co">#&gt;    top      1      2      3    1.1    1.2    2.1    2.2    3.1    3.2 </span></span>
<span><span class="co">#&gt; 215500  86000  46000  83500  25000  61000  37000   9000  62000  21500</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simple-fault-tree-analysis">Simple Fault Tree Analysis<a class="anchor" aria-label="anchor" href="#simple-fault-tree-analysis"></a>
</h2>
<p>Fault tree analysis is similarly recursive. We show here a
greatly-simplified <span class="citation">(Devasia 2021)</span> example
to illustrate a particular feature of the implementation.</p>
<div class="float">
<img src="fta-example.jpg" alt="https://control.com/technical-articles/deep-dive-into-fault-tree-analysis/"><div class="figcaption"><a href="https://control.com/technical-articles/deep-dive-into-fault-tree-analysis/" class="external-link uri">https://control.com/technical-articles/deep-dive-into-fault-tree-analysis/</a></div>
</div>
<p>For the purpose of illustration, we make the following simplifying
assumptions:</p>
<ul>
<li><p>Every gate is associated with an intermediate event, and each
gate/event pair can be represented by a single vertex in the
tree.</p></li>
<li><p>Only gates of type AND and OR are permitted.</p></li>
</ul>
<p>Our initial fault properties table is:</p>
<pre><code><span><span class="co">#&gt;                                    id  type prob</span></span>
<span><span class="co">#&gt; 1                   Water overflowing    or   NA</span></span>
<span><span class="co">#&gt; 2 Circuit failure and no warning lamp   and   NA</span></span>
<span><span class="co">#&gt; 3                      Sensor failure basic 0.02</span></span>
<span><span class="co">#&gt; 4                 No voltage at input    or   NA</span></span>
<span><span class="co">#&gt; 5                        Chip failure basic 0.05</span></span>
<span><span class="co">#&gt; 6                 Warning lamp burned basic 0.03</span></span>
<span><span class="co">#&gt; 7                     No V in network basic 0.12</span></span>
<span><span class="co">#&gt; 8                         Fuse burned basic 0.23</span></span></code></pre>
<p>The edge list of the fault tree is:</p>
<pre><code><span><span class="co">#&gt; + 7/7 edges from 2d2da5d (vertex names):</span></span>
<span><span class="co">#&gt; [1] Circuit failure and no warning lamp-&gt;Water overflowing                  </span></span>
<span><span class="co">#&gt; [2] Sensor failure                     -&gt;Water overflowing                  </span></span>
<span><span class="co">#&gt; [3] No voltage at input                -&gt;Water overflowing                  </span></span>
<span><span class="co">#&gt; [4] Chip failure                       -&gt;Circuit failure and no warning lamp</span></span>
<span><span class="co">#&gt; [5] Warning lamp burned                -&gt;Circuit failure and no warning lamp</span></span>
<span><span class="co">#&gt; [6] No V in network                    -&gt;No voltage at input                </span></span>
<span><span class="co">#&gt; [7] Fuse burned                        -&gt;No voltage at input</span></span></code></pre>
<p>Get and set methods for this example are simple and obvious:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_get_fault_props</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">id</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    type <span class="op">=</span> <span class="fu"><a href="../reference/df_get_by_id.html">df_get_by_id</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">id</span>, <span class="st">"type"</span><span class="op">)</span>,</span>
<span>    prob <span class="op">=</span> <span class="fu"><a href="../reference/df_get_by_id.html">df_get_by_id</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">id</span>, <span class="st">"prob"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">df_set_fault_props</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">id</span>, <span class="va">v</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/df_set_by_id.html">df_set_by_id</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">id</span>, <span class="st">"prob"</span>, <span class="va">v</span><span class="op">$</span><span class="va">prob</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>In most applications (e.g., mass properties), the combining operation
only the values to be combined, and is therefore passed only those
values as input. In the case of a fault tree, however, the input for an
AND gate are multiplied, whereas for an OR gate are summed. We can
accommodate this situation by passing an optional <em>type</em> argument
to the combiner follows:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combine_fault_props</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">vl</span>, <span class="va">type</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span></span>
<span>      f <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"and"</span><span class="op">)</span> <span class="st">"*"</span> <span class="kw">else</span> <span class="st">"+"</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Map</a></span><span class="op">(</span>f <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">v</span><span class="op">)</span> <span class="va">v</span><span class="op">$</span><span class="va">prob</span>, <span class="va">vl</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">update_fault_props</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ds</span>, <span class="va">parent_key</span>, <span class="va">child_keys</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/update_prop.html">update_prop</a></span><span class="op">(</span></span>
<span>    <span class="va">ds</span>,</span>
<span>    target <span class="op">=</span> <span class="va">parent_key</span>,</span>
<span>    sources <span class="op">=</span> <span class="va">child_keys</span>,</span>
<span>    set <span class="op">=</span> <span class="va">df_set_fault_props</span>,</span>
<span>    get <span class="op">=</span> <span class="va">df_get_fault_props</span>,</span>
<span>    combine <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">vl</span><span class="op">)</span></span>
<span>      <span class="fu">combine_fault_props</span><span class="op">(</span><span class="va">vl</span>, <span class="fu">df_get_fault_props</span><span class="op">(</span><span class="va">ds</span>, <span class="va">parent_key</span><span class="op">)</span><span class="op">$</span><span class="va">type</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">validate_fault_props</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fp</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">fp</span><span class="op">$</span><span class="va">type</span> <span class="op">!=</span> <span class="st">"basic"</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"invalid leaf node type %s"</span>, <span class="va">fp</span><span class="op">$</span><span class="va">type</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">fp</span><span class="op">$</span><span class="va">prob</span><span class="op">)</span> <span class="op">||</span> <span class="va">fp</span><span class="op">$</span><span class="va">prob</span> <span class="op">&lt;</span> <span class="fl">0.0</span> <span class="op">||</span> <span class="va">fp</span><span class="op">$</span><span class="va">prob</span> <span class="op">&gt;</span> <span class="fl">1.0</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"invalid probability value %f"</span>, <span class="va">fp</span><span class="op">$</span><span class="va">prob</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="cn">TRUE</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">validate_fault_props_table</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">tree</span>, <span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/validate_ds.html">validate_ds</a></span><span class="op">(</span><span class="va">tree</span>, <span class="va">df</span>, <span class="va">df_get_ids</span>, <span class="va">df_get_fault_props</span>, <span class="va">validate_fault_props</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Calling <code><a href="../reference/rollup.html">rollup()</a></code> in the usual manner yields:</p>
<pre><code><span><span class="co">#&gt;                                    id  type   prob</span></span>
<span><span class="co">#&gt; 1                   Water overflowing    or 0.3715</span></span>
<span><span class="co">#&gt; 2 Circuit failure and no warning lamp   and 0.0015</span></span>
<span><span class="co">#&gt; 3                      Sensor failure basic 0.0200</span></span>
<span><span class="co">#&gt; 4                 No voltage at input    or 0.3500</span></span>
<span><span class="co">#&gt; 5                        Chip failure basic 0.0500</span></span>
<span><span class="co">#&gt; 6                 Warning lamp burned basic 0.0300</span></span>
<span><span class="co">#&gt; 7                     No V in network basic 0.1200</span></span>
<span><span class="co">#&gt; 8                         Fuse burned basic 0.2300</span></span></code></pre>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-igraph_manual" class="csl-entry">
Csárdi, Gábor, Tamás Nepusz, Vincent Traag, Szabolcs Horvát, Fabio
Zanini, Daniel Noom, and Kirill Müller. 2025. <em><span class="nocase">igraph</span>: Network Analysis and Visualization in
r</em>. <a href="https://doi.org/10.5281/zenodo.7682609" class="external-link">https://doi.org/10.5281/zenodo.7682609</a>.
</div>
<div id="ref-fta" class="csl-entry">
Devasia, Anish. 2021. <span>“Deep Dive into Fault Tree Analysis.”</span>
2021. <a href="https://control.com/technical-articles/deep-dive-into-fault-tree-analysis/" class="external-link">https://control.com/technical-articles/deep-dive-into-fault-tree-analysis/</a>.
</div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by James Steven Jenkins.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
